{% load static %}
<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>AutoWave ‚Äî Rent & Buy</title>

	<link rel="stylesheet" href="{% static 'css/home.css' %}">
	<link rel="stylesheet" href="{% static 'css/responsive.css' %}">
	<script src="https://unpkg.com/htmx.org@1.10.0"></script>
</head>
<body hx-get="." hx-trigger="every 12s" hx-swap="outerHTML">
	<!-- Loading Overlay -->
	<div id="loadingOverlay" class="loading-overlay hidden">
		<div class="loading-container">
			<div class="spinner"></div>
			<p class="loading-text">Loading...</p>
		</div>
	</div>

	{% if request.user.is_authenticated %}
	<div id="welcomeNotification" class="welcome-notification">
		Welcome back, {{ request.user.get_full_name|default:request.user.username }}! üéâ
	</div>
	{% endif %}


	<header class="topbar">
		<div class="container topbar-inner" style="display:flex;align-items:center;justify-content:space-between;">
			<div class="logo" style="font-weight:700;font-size:1.25rem;color:#5ef0c6">AutoWave</div>

			<button class="hamburger" id="hamburgerBtn" aria-label="Toggle navigation">
				<span></span>
				<span></span>
				<span></span>
			</button>

			<nav class="main-nav" id="mainNav">
				<a href="#home">Home</a>
				<a href="#rent">Rent</a>
				<a href="#sale">Buy</a>
				<a href="#about">About Us</a>
				<a href="#contact">Contact Us</a>
				<a href="#location">Location</a>			
				<a href="#process">How It Works</a>
				<a href="#reviews">Reviews</a>

				
			</nav>

			<div class="auth">
				{% if request.user.is_authenticated %}
				<div class="user-profile">
					<div class="user-avatar">
						{% if request.user.profile_image %}
							<img src="{{ request.user.profile_image.url }}" alt="{{ request.user.get_full_name|default:request.user.username }}">
						{% else %}
							{{ request.user.first_name|first|upper|default:request.user.username|first|upper }}
						{% endif %}
					</div>
					<div class="user-info">
						<div class="user-name">{{ request.user.get_full_name|default:request.user.username }}</div>
						<div class="user-status">Online</div>
					</div>
				</div>
				<a href="{% url 'logout' %}" class="btn ghost">Logout</a>
				{% else %}
				<a href="{% url 'login' %}" class="btn ghost">Login</a>
				<a href="{% url 'signup' %}" class="btn primary">Sign Up</a>
				{% endif %}
			</div>
		</div>
	</header>


	<main id="home">


<section class="hero-banner">
    <div class="hero-content">
        <h1>About AutoWave</h1>
        <p>
            AutoWave offers premium cars for rent and sale with flexible plans, 
            transparent pricing, and modern features. Drive with confidence.
        </p>
        <button class="btn primary">Learn More</button>
    </div>
</section>

<section id="rent" class="cars-rent container glass reveal" data-direction="left">
    <div class="cars-section-header">
        <h2>Available for Rent</h2>
    </div>
    <div class="grid" id="rentCars" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem;">
		{% for car in rentCars %}
		<div class="car-card glass reveal" data-direction="left" data-id="{{ car.id }}">
            <div class="car-card-media" style="height:160px;overflow:hidden;position:relative;">
                {% if car.photo %}
                <img class="card-main" src="{{ car.photo.url }}" alt="{{ car.model }}" style="width:100%;height:100%;object-fit:cover;transition:transform 0.3s ease;">
                {% else %}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#111;color:#ddd">No image</div>
                {% endif %}
            </div>
            <div class="car-card-body" style="padding:1.5rem">
                <h3 style="color:#5ef0c6;margin:0 0 0.5rem 0;font-size:1.15rem;font-weight:700;">{{ car.model }}</h3>
                <p class="price" style="color:rgba(230,238,248,0.7);font-size:0.9rem;margin:0 0 1rem 0;">{{ car.price_display }}</p>

				{% if focus_car_id and car.id == focus_car_id %}
					{# If focused, show only the relevant action for thisu car type #}
					{% if car.car_type == 'rent' %}
						<button class="btn primary rent-btn" data-id="{{ car.id }}">Rent</button>
					{% else %}
						<button class="btn primary buy-btn" data-id="{{ car.id }}">Buy</button>
					{% endif %}
				{% else %}
					<!-- Updated Details button -->
					<a class="btn ghost" href="{% url 'usercar_detail' car.id %}">Details</a>
					<button class="btn primary rent-btn" data-id="{{ car.id }}">Rent</button>
				{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<section id="sale" class="cars-sale container glass reveal" data-direction="right">
    <div class="cars-section-header">
        <h2>Cars for Sale</h2>
    </div>
    <div class="grid" id="saleCars" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem;">
        {% for car in saleCars %}
        <div class="car-card glass reveal" data-direction="right" data-id="{{ car.id }}">
            <div class="car-card-media" style="height:160px;overflow:hidden;position:relative;">
                {% if car.photo %}
                <img class="card-main" src="{{ car.photo.url }}" alt="{{ car.model }}" style="width:100%;height:100%;object-fit:cover;transition:transform 0.3s ease;">
                {% else %}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#111;color:#ddd">No image</div>
                {% endif %}
            </div>
            <div class="car-card-body" style="padding:1.5rem">
                <h3 style="color:#5ef0c6;margin:0 0 0.5rem 0;font-size:1.15rem;font-weight:700;">{{ car.model }}</h3>
                <p class="price" style="color:rgba(230,238,248,0.7);font-size:0.9rem;margin:0 0 1rem 0;">{{ car.price_display }}</p>

				{% if focus_car_id and car.id == focus_car_id %}
					{% if car.car_type == 'rent' %}
						<button class="btn primary rent-btn" data-id="{{ car.id }}">Rent</button>
					{% else %}
						<button class="btn primary buy-btn" data-id="{{ car.id }}">Buy</button>
					{% endif %}
				{% else %}
					<!-- Updated Details button -->
					<a class="btn ghost" href="{% url 'usercar_detail' car.id %}">Details</a>
					<button class="btn primary buy-btn" data-id="{{ car.id }}">Buy</button>
				{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>


		<section id="location" class="map-section glass container reveal" data-direction="right">
			<h2>Our Office Location</h2>
			<div class="map-wrap" style="height:320px;overflow:hidden">
				<iframe
					src="https://www.google.com/maps?q=37.7749,-122.4194&z=15&output=embed"
					style="border:0;width:100%;height:100%;" allowfullscreen="" loading="lazy"></iframe>
			</div>
			<p style="margin-top:.6rem;color:var(--muted);font-size:.95rem">
				<a href="https://maps.app.goo.gl/8KDWcveHf6M1BXHp9" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Open in Google Maps</a>
			</p>
		</section>

		<section id="process" class="container glass reveal" data-direction="right">
			<h2>How Our Service Works</h2>
			<div class="process-steps" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:1rem">
				<div class="step glass"><h3>1. Login / Create Account</h3><p>Use your email to login or register.</p></div>
				<div class="step glass"><h3>2. Choose Your Car</h3><p>Select rent or buy from our modern fleet.</p></div>
				<div class="step glass"><h3>3. Submit the Form</h3><p>Fill your booking or purchase information.</p></div>
				<div class="step glass"><h3>4. Get Confirmation</h3><p>A confirmation will appear shortly in your account.</p></div>
				<div class="step glass"><h3>5. Visit Our Location</h3><p>Come to our office and pick up / inspect the car.</p></div>
			</div>
		</section>

		<section id="reviews" class="container glass reveal" data-direction="left">
			<div class="reviews-section-header">
				<h2>What Our Customers Say</h2>
				{% if request.user.is_authenticated %}
				<div class="reviews-stats">
					<div class="stat">
						<div class="stat-number">{{ reviews|length }}</div>
						<div class="stat-label">Total Reviews</div>
					</div>
				</div>
				{% endif %}
			</div>

			<!-- Review Submission Form (Only for logged-in users) -->
			{% if request.user.is_authenticated %}
			<div class="review-form-container">
				<h3>Share Your Experience</h3>
				<form method="post" action="{% url 'submit_review' %}" class="review-form">
					{% csrf_token %}
					
					<div class="form-group">
						<label for="review_text">Your Review</label>
						<textarea 
							id="review_text" 
							name="review_text" 
							class="review-textarea" 
							placeholder="Tell us about your experience with AutoWave..."
							required></textarea>
					</div>

					<div class="form-group">
						<label>Rating</label>
						<div class="rating-selector">
							<div class="star-input" id="starInput">
								<input type="radio" id="star5" name="review_rating" value="5" checked>
								<label for="star5">‚òÖ</label>
								<input type="radio" id="star4" name="review_rating" value="4">
								<label for="star4">‚òÖ</label>
								<input type="radio" id="star3" name="review_rating" value="3">
								<label for="star3">‚òÖ</label>
								<input type="radio" id="star2" name="review_rating" value="2">
								<label for="star2">‚òÖ</label>
								<input type="radio" id="star1" name="review_rating" value="1">
								<label for="star1">‚òÖ</label>
							</div>
						</div>
					</div>

					<div class="review-form-buttons">
						<button type="submit" class="btn primary">Post Review</button>
					</div>
				</form>
			</div>
			{% else %}
			<div class="review-form-container" style="text-align: center; border-color: rgba(94, 240, 198, 0.2); background: rgba(94, 240, 198, 0.05);">
				<p style="color: rgba(230, 238, 248, 0.7); margin: 0;">
					<a href="{% url 'login' %}" style="color: #5ef0c6; text-decoration: none; font-weight: 600;">Login</a> or 
					<a href="{% url 'signup' %}" style="color: #5ef0c6; text-decoration: none; font-weight: 600;">Sign up</a> 
					to share your experience!
				</p>
			</div>
			{% endif %}

			<!-- Reviews Display -->
			<div class="reviews-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem;margin-top:2rem;">
				{% if reviews %}
					{% for r in reviews %}
					<div class="review-card glass">
						<div class="review-header">
							<div class="review-user-info">
								<p class="review-user-name">
									{% if r.user %}
										{{ r.user.get_full_name|default:r.user.username }}
									{% else %}
										{{ r.name }}
									{% endif %}
								</p>
								{% if r.created_at %}
								<p class="review-date">{{ r.created_at|date:"M d, Y" }}</p>
								{% endif %}
							</div>
							<div class="review-rating">
								{% if r.rating %}
									{% for i in "x"|rjust:r.rating %}‚òÖ{% endfor %}
								{% else %}
									‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
								{% endif %}
							</div>
						</div>
						<p class="review-text">{{ r.text }}</p>
					</div>
					{% endfor %}
				{% else %}
				<div class="review-empty">
					<p style="color: rgba(230, 238, 248, 0.6);">No reviews yet. Be the first to share your experience!</p>
				</div>
				{% endif %}
			</div>
		</section>

		<section id="about" class="container about glass reveal" data-direction="right">
			<h2>About Us</h2>
			<p>
				AutoWave blends premium vehicles, flexible rentals and transparent buying. We curate a modern fleet ‚Äî from efficient city cars and sporty coupes to family vans and electric models ‚Äî all inspected and maintained to high standards.
			</p>
			<p>
				Our mission is simple: make mobility effortless. Rent by the day, week, or month with transparent pricing and comprehensive support, or buy with confidence through our certified pre-owned checks and financing guidance. We offer airport pickup, long-term corporate leasing, and dedicated customer care.
			</p>
		</section>

		<section id="contact" class="container contact glass reveal" data-direction="left">
			<h2>Contact Us</h2>
			<p>Email: hello@autowave.example ‚Ä¢ Phone: (555) 123-4567</p>
		</section>

	</main>

	<!-- My Bookings Section -->
<section id="my-bookings" class="container" style="margin-top:3rem;margin-bottom:2rem;">
	<h2>My Bookings</h2>
	{% if my_bookings %}
		<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.5rem;margin-top:2rem;">
			{% for booking in my_bookings %}
				<div class="card" style="padding:1.5rem;border: 1px solid rgba(255,255,255,0.08);">
					<div style="margin-bottom:1.25rem;">
						<h4 style="color:#5ef0c6;margin:0 0 0.75rem 0;font-size:1.15rem;">
							{% if booking.car %}
								{{ booking.car.model }}
							{% else %}
								Booking #{{ booking.id }}
							{% endif %}
						</h4>
						<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;color:rgba(230,238,248,0.8);font-size:0.9rem;margin-bottom:1rem;">
							<div style="background:rgba(94,240,198,0.08);padding:0.75rem;border-radius:6px;border-left:2px solid #5ef0c6;">
								<div style="font-size:0.75rem;color:rgba(230,238,248,0.6);margin-bottom:0.25rem;text-transform:uppercase;font-weight:600;">ID</div>
								<div style="font-weight:700;color:#5ef0c6;">#{{ booking.id }}</div>
							</div>
							<div style="background:rgba(59,130,246,0.08);padding:0.75rem;border-radius:6px;border-left:2px solid #3b82f6;">
								<div style="font-size:0.75rem;color:rgba(230,238,248,0.6);margin-bottom:0.25rem;text-transform:uppercase;font-weight:600;">Type</div>
								<div style="font-weight:700;color:#3b82f6;">{{ booking.get_request_type_display }}</div>
							</div>
						</div>
						<div style="background:rgba(255,255,255,0.04);padding:1rem;border-radius:8px;border:1px solid rgba(255,255,255,0.08);">
							<div style="font-size:0.8rem;color:rgba(230,238,248,0.6);margin-bottom:0.5rem;text-transform:uppercase;font-weight:600;">Status</div>
							<div style="display:flex;align-items:center;gap:0.5rem;">
								<span class="booking-status {% if booking.status == 'confirmed' %}confirmed{% elif booking.status == 'completed' %}completed{% elif booking.status == 'rejected' %}rejected{% elif booking.status == 'cancelled' %}cancelled{% elif booking.status == 'cancel_requested' %}cancel-requested{% else %}pending{% endif %}" style="font-size:1.1rem;">
									{{ booking.get_status_display }}
								</span>
								{% if booking.status == 'completed' %}<span style="color:#3b82f6;font-size:0.8rem;">‚úì Delivery Complete</span>{% endif %}
								{% if booking.status == 'cancelled' %}<span style="color:#ef4444;font-size:0.8rem;">‚úó Cancelled</span>{% endif %}
								{% if booking.status == 'rejected' %}<span style="color:#ef4444;font-size:0.8rem;">‚úó Rejected</span>{% endif %}
							</div>
						</div>
						<p style="color:rgba(230,238,248,0.6);font-size:0.8rem;margin:1rem 0 0 0;">
							<strong>Created:</strong> {{ booking.created_at|date:"M d, Y H:i" }}
						</p>
					</div>

					<!-- Show Cancel button only for confirmed bookings (not pending, not already cancelled/rejected) -->
					{% if booking.status == 'confirmed' %}
						<form method="post" action="{% url 'booking_cancel_request' booking.id %}" style="display:inline;width:100%;">
							{% csrf_token %}
							<button class="btn ghost" type="submit" style="width:100%;margin-bottom:0.5rem;font-size:0.9rem;">Request Cancellation</button>
						</form>
						<p style="font-size:0.8rem;color:rgba(230,238,248,0.5);margin:0;text-align:center;">
							Our team will review your request
						</p>
					{% else %}
						<button class="btn ghost" disabled style="width:100%;opacity:0.4;cursor:not-allowed;font-size:0.9rem;">
							{% if booking.status == 'pending' %}‚è≥ Pending Review{% elif booking.status == 'cancel_requested' %}‚è≥ Cancel Pending{% else %}‚Äî{% endif %}
						</button>
						<p style="font-size:0.75rem;color:rgba(230,238,248,0.4);margin:0.5rem 0 0 0;text-align:center;">
							{% if booking.status == 'pending' %}Waiting for staff review{% elif booking.status == 'cancel_requested' %}Cancellation under review{% else %}No actions available{% endif %}
						</p>
					{% endif %}
				</div>
			{% endfor %}
		</div>
	{% else %}
		<div style="text-align:center;padding:3rem 1rem;background:rgba(94,240,198,0.05);border:2px dashed rgba(94,240,198,0.3);border-radius:12px;margin-top:2rem;">
			<p style="color:rgba(230,238,248,0.6);font-size:1.05rem;margin:0;">
				You have no bookings yet. 
				<a href="#cars" style="color:#5ef0c6;text-decoration:none;font-weight:700;">Browse cars</a> to get started!
			</p>
		</div>
	{% endif %}
</section>

	<footer class="footer">
		<div class="container">¬© AutoWave ‚Äî Smooth rides, clear deals.</div>
	</footer>




	<!-- Booking Modal -->
	<div id="bookingOverlay" class="modal-overlay hidden">
		<div class="modal" id="bookingModal">
			<button class="modal-close" id="bookingClose">&times;</button>
			<div class="modal-content">
				<form id="bookingForm" class="auth-form" method="post" action="{% url 'book' %}" enctype="multipart/form-data">
					{% csrf_token %}
					<h3 style="color:#e6eef8">Book this Car</h3>
					<input type="hidden" name="car_id" value="">
					<input type="hidden" name="request_type" value="rent">
					<label>Full Name</label>
					<input type="text" name="full_name" required>
					<label>Mobile Number</label>
					<input type="text" name="mobile" required>
					<label class="rent-only">Start Date</label>
					<input class="rent-only" type="date" name="start_date">
					<label class="rent-only">End Date</label>
					<input class="rent-only" type="date" name="end_date">
					<label class="rent-only">Location</label>
					<input class="rent-only" type="text" name="location" required>
					<label class="rent-only">NID / Passport Number</label>
					<input class="rent-only" type="text" name="id_number" required>
					<label class="rent-only">Driving License Number</label>
					<input class="rent-only" type="text" name="driving_license_number">
					<label class="rent-only">Driving License Photo</label>
					<input class="rent-only" type="file" name="driving_license_photo" accept="image/*">
					<label>Your Photo</label>
					<input type="file" name="client_photo" accept="image/*">
					<div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:flex-end;">
						<button type="button" class="btn ghost" id="bookingCancel">Cancel</button>
						<button type="submit" class="btn primary">Submit Booking</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Buy Booking Modal (Separate for Cars for Sale) -->
	<div id="buyBookingOverlay" class="modal-overlay hidden">
		<div class="modal" id="buyBookingModal">
			<button class="modal-close" id="buyBookingClose">&times;</button>
			<div class="modal-content">
				<form id="buyBookingForm" class="auth-form" method="post" action="{% url 'book' %}" enctype="multipart/form-data">
					{% csrf_token %}
					<h3 style="color:#e6eef8">Purchase this Car</h3>
					<input type="hidden" name="car_id" value="">
					<input type="hidden" name="request_type" value="buy">
					<label>Full Name</label>
					<input type="text" name="full_name" required>
					<label>Mobile Number</label>
					<input type="text" name="mobile" required>
					<label>Your Photo</label>
					<input type="file" name="client_photo" accept="image/*">
					<div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:flex-end;">
						<button type="button" class="btn ghost" id="buyBookingCancel">Cancel</button>
						<button type="submit" class="btn primary">Submit Purchase Request</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	

	<script src="{% static 'js/home.js' %}"></script>
</body>
</html>